{"ast":null,"code":"import { createAction, handleActions } from \"redux-actions\";\nimport { produce } from \"immer\";\nimport { firestore } from \"../../shared/firebase\";\nimport firebase from \"firebase\";\nimport { actionCreators as postActions } from \"./post\";\nconst SET_LIKE = \"SET_LIKE\";\nconst ADD_LIKE = \"ADD_LIKE\";\nconst LOADING = \"LOADING\";\nconst UN_LIKE = \"UN_LIKE\";\nconst setlike = createAction(SET_LIKE, (post_id, is_liked) => ({\n  post_id,\n  is_liked\n}));\nconst addlike = createAction(ADD_LIKE, (post_id, user_id) => ({\n  post_id,\n  user_id\n}));\nconst unlike = createAction(UN_LIKE, (post_id, user_id) => ({\n  post_id,\n  user_id\n}));\nconst initialState = {\n  list: {}\n};\n\nconst addLikeFB = post_id => {\n  return function (dispatch, getState, {\n    history\n  }) {\n    const likeDB = firestore.collection(\"like\");\n    const user_info = getState().user.user;\n    let like = {\n      post_id: post_id,\n      user_id: user_info.uid\n    };\n    likeDB.add(like).then(doc => {\n      const postDB = firestore.collection(\"post\");\n      const post = getState().post.list.find(l => l.id === post_id);\n      const increment = firebase.firestore.FieldValue.increment(1);\n      like = { ...like,\n        id: doc.id\n      };\n      postDB.doc(post_id).update({\n        like_cnt: increment\n      }).then(_post => {\n        dispatch(addlike(post_id, user_info.uid));\n\n        if (post) {\n          dispatch(postActions.updatePost(post_id, {\n            like_cnt: parseInt(post.like_cnt) + 1\n          }));\n        }\n      });\n    });\n  };\n};\n\nconst getLikeFB = post_id => {\n  return function (dispatch, getState, {\n    history\n  }) {\n    if (!post_id) {\n      return;\n    }\n\n    const likeDB = firestore.collection(\"like\");\n    likeDB.where(\"post_id\", \"==\", post_id).get().then(docs => {\n      let list = [];\n      docs.forEach(doc => {\n        list.push(doc.data().user_id);\n      });\n      console.log(list);\n      dispatch(setLike(post_id, list));\n    }).catch(error => {\n      console.log(\"좋아요 정보를 가져올 수가 없네요ㅜㅜ\", error);\n    });\n  };\n};\n\nconst unLikeFB = post_id => {\n  return function (dispatch, getState, {\n    history\n  }) {\n    const likeDB = firestore.collection(\"like\");\n    const user_info = getState().user.user;\n    likeDB.where(\"post_id\", \"==\", post_id).where(\"user_id\", \"==\", user_info.uid).get().then(docs => {\n      let id = \"\";\n      docs.forEach(doc => id = doc.id);\n      likeDB.doc(id).delete().then(() => {\n        const postDB = firestore.collection(\"post\");\n        const post = getState().post.list.find(l => l.id === post_id);\n        const decrement = firebase.firestore.FieldValue.increment(-1);\n        postDB.doc(post_id).update({\n          like_cnt: decrement\n        }).then(_post => {\n          dispatch(unlike(post_id, user_info.uid));\n\n          if (post) {\n            if (parseInt(post.like_cnt) === 0) {\n              return;\n            }\n\n            dispatch(postActions.updatePost(post_id, {\n              like_cnt: parseInt(post.like_cnt) - 1\n            }));\n          }\n        });\n      });\n    }).catch(error => {\n      console.log(\"좋아요를 취소할 포스트를 찾을수가 없어요ㅜㅜ\");\n    });\n  };\n};\n\nexport default handleActions({\n  [SET_LIKE]: (state, action) => produce(state, draft => {\n    draft.list.is_liked = action.payload.is_liked;\n  }),\n  [ADD_LIKE]: (state, action) => produce(state, draft => {\n    draft.list[action.payload.post_id].push(action.payload.user_id);\n  }),\n  [LOADING]: (state, action) => produce(state, draft => {\n    draft.is_loading = action.payload.is_loading;\n  })\n}, initialState);\nconst actionCreators = {\n  addLikeFB,\n  getLikeFB,\n  unLikeFB\n};\nexport { actionCreators };","map":{"version":3,"sources":["/Users/frankie/sparta/hanghae_react/magazine_test/src/redux/modules/like.js"],"names":["createAction","handleActions","produce","firestore","firebase","actionCreators","postActions","SET_LIKE","ADD_LIKE","LOADING","UN_LIKE","setlike","post_id","is_liked","addlike","user_id","unlike","initialState","list","addLikeFB","dispatch","getState","history","likeDB","collection","user_info","user","like","uid","add","then","doc","postDB","post","find","l","id","increment","FieldValue","update","like_cnt","_post","updatePost","parseInt","getLikeFB","where","get","docs","forEach","push","data","console","log","setLike","catch","error","unLikeFB","delete","decrement","state","action","draft","payload","is_loading"],"mappings":"AAAA,SAASA,YAAT,EAAuBC,aAAvB,QAA4C,eAA5C;AACA,SAASC,OAAT,QAAwB,OAAxB;AACA,SAASC,SAAT,QAA0B,uBAA1B;AACA,OAAOC,QAAP,MAAqB,UAArB;AACA,SAASC,cAAc,IAAIC,WAA3B,QAA8C,QAA9C;AAEA,MAAMC,QAAQ,GAAG,UAAjB;AACA,MAAMC,QAAQ,GAAG,UAAjB;AACA,MAAMC,OAAO,GAAG,SAAhB;AACA,MAAMC,OAAO,GAAG,SAAhB;AAEA,MAAMC,OAAO,GAAGX,YAAY,CAACO,QAAD,EAAW,CAACK,OAAD,EAAUC,QAAV,MAAwB;AAC7DD,EAAAA,OAD6D;AAE7DC,EAAAA;AAF6D,CAAxB,CAAX,CAA5B;AAIA,MAAMC,OAAO,GAAGd,YAAY,CAACQ,QAAD,EAAW,CAACI,OAAD,EAAUG,OAAV,MAAuB;AAC5DH,EAAAA,OAD4D;AAE5DG,EAAAA;AAF4D,CAAvB,CAAX,CAA5B;AAIA,MAAMC,MAAM,GAAGhB,YAAY,CAACU,OAAD,EAAU,CAACE,OAAD,EAAUG,OAAV,MAAuB;AAC1DH,EAAAA,OAD0D;AAE1DG,EAAAA;AAF0D,CAAvB,CAAV,CAA3B;AAMA,MAAME,YAAY,GAAG;AACnBC,EAAAA,IAAI,EAAE;AADa,CAArB;;AAMA,MAAMC,SAAS,GAAIP,OAAD,IAAa;AAC7B,SAAO,UAAUQ,QAAV,EAAoBC,QAApB,EAA8B;AAAEC,IAAAA;AAAF,GAA9B,EAA2C;AAChD,UAAMC,MAAM,GAAGpB,SAAS,CAACqB,UAAV,CAAqB,MAArB,CAAf;AACA,UAAMC,SAAS,GAAGJ,QAAQ,GAAGK,IAAX,CAAgBA,IAAlC;AAEA,QAAIC,IAAI,GAAG;AACTf,MAAAA,OAAO,EAAEA,OADA;AAETG,MAAAA,OAAO,EAAEU,SAAS,CAACG;AAFV,KAAX;AAKAL,IAAAA,MAAM,CAACM,GAAP,CAAWF,IAAX,EAAiBG,IAAjB,CAAuBC,GAAD,IAAS;AAC7B,YAAMC,MAAM,GAAG7B,SAAS,CAACqB,UAAV,CAAqB,MAArB,CAAf;AAEA,YAAMS,IAAI,GAAGZ,QAAQ,GAAGY,IAAX,CAAgBf,IAAhB,CAAqBgB,IAArB,CAA2BC,CAAD,IAAOA,CAAC,CAACC,EAAF,KAASxB,OAA1C,CAAb;AAEA,YAAMyB,SAAS,GAAGjC,QAAQ,CAACD,SAAT,CAAmBmC,UAAnB,CAA8BD,SAA9B,CAAwC,CAAxC,CAAlB;AAEAV,MAAAA,IAAI,GAAG,EAAE,GAAGA,IAAL;AAAWS,QAAAA,EAAE,EAAEL,GAAG,CAACK;AAAnB,OAAP;AAEAJ,MAAAA,MAAM,CACHD,GADH,CACOnB,OADP,EAEG2B,MAFH,CAEU;AAAEC,QAAAA,QAAQ,EAAEH;AAAZ,OAFV,EAGGP,IAHH,CAGSW,KAAD,IAAW;AACfrB,QAAAA,QAAQ,CAACN,OAAO,CAACF,OAAD,EAAUa,SAAS,CAACG,GAApB,CAAR,CAAR;;AAEA,YAAIK,IAAJ,EAAU;AACRb,UAAAA,QAAQ,CACNd,WAAW,CAACoC,UAAZ,CAAuB9B,OAAvB,EAAgC;AAC9B4B,YAAAA,QAAQ,EAAEG,QAAQ,CAACV,IAAI,CAACO,QAAN,CAAR,GAA0B;AADN,WAAhC,CADM,CAAR;AAKD;AACF,OAbH;AAcD,KAvBD;AAwBD,GAjCD;AAkCD,CAnCD;;AAqCA,MAAMI,SAAS,GAAIhC,OAAD,IAAa;AAC7B,SAAO,UAAUQ,QAAV,EAAoBC,QAApB,EAA8B;AAAEC,IAAAA;AAAF,GAA9B,EAA2C;AAChD,QAAI,CAACV,OAAL,EAAc;AACZ;AACD;;AAED,UAAMW,MAAM,GAAGpB,SAAS,CAACqB,UAAV,CAAqB,MAArB,CAAf;AAEAD,IAAAA,MAAM,CACHsB,KADH,CACS,SADT,EACoB,IADpB,EAC0BjC,OAD1B,EAEGkC,GAFH,GAGGhB,IAHH,CAGSiB,IAAD,IAAU;AACd,UAAI7B,IAAI,GAAG,EAAX;AACA6B,MAAAA,IAAI,CAACC,OAAL,CAAcjB,GAAD,IAAS;AACpBb,QAAAA,IAAI,CAAC+B,IAAL,CAAUlB,GAAG,CAACmB,IAAJ,GAAWnC,OAArB;AACD,OAFD;AAGAoC,MAAAA,OAAO,CAACC,GAAR,CAAYlC,IAAZ;AAEAE,MAAAA,QAAQ,CAACiC,OAAO,CAACzC,OAAD,EAAUM,IAAV,CAAR,CAAR;AACD,KAXH,EAYGoC,KAZH,CAYUC,KAAD,IAAW;AAChBJ,MAAAA,OAAO,CAACC,GAAR,CAAY,sBAAZ,EAAoCG,KAApC;AACD,KAdH;AAeD,GAtBD;AAuBD,CAxBD;;AA0BA,MAAMC,QAAQ,GAAI5C,OAAD,IAAa;AAC5B,SAAO,UAAUQ,QAAV,EAAoBC,QAApB,EAA8B;AAAEC,IAAAA;AAAF,GAA9B,EAA2C;AAChD,UAAMC,MAAM,GAAGpB,SAAS,CAACqB,UAAV,CAAqB,MAArB,CAAf;AACA,UAAMC,SAAS,GAAGJ,QAAQ,GAAGK,IAAX,CAAgBA,IAAlC;AAEAH,IAAAA,MAAM,CACHsB,KADH,CACS,SADT,EACoB,IADpB,EAC0BjC,OAD1B,EAEGiC,KAFH,CAES,SAFT,EAEoB,IAFpB,EAE0BpB,SAAS,CAACG,GAFpC,EAGGkB,GAHH,GAIGhB,IAJH,CAISiB,IAAD,IAAU;AACd,UAAIX,EAAE,GAAG,EAAT;AACAW,MAAAA,IAAI,CAACC,OAAL,CAAcjB,GAAD,IAAUK,EAAE,GAAGL,GAAG,CAACK,EAAhC;AACAb,MAAAA,MAAM,CACHQ,GADH,CACOK,EADP,EAEGqB,MAFH,GAGG3B,IAHH,CAGQ,MAAM;AACV,cAAME,MAAM,GAAG7B,SAAS,CAACqB,UAAV,CAAqB,MAArB,CAAf;AAEA,cAAMS,IAAI,GAAGZ,QAAQ,GAAGY,IAAX,CAAgBf,IAAhB,CAAqBgB,IAArB,CAA2BC,CAAD,IAAOA,CAAC,CAACC,EAAF,KAASxB,OAA1C,CAAb;AAEA,cAAM8C,SAAS,GAAGtD,QAAQ,CAACD,SAAT,CAAmBmC,UAAnB,CAA8BD,SAA9B,CAAwC,CAAC,CAAzC,CAAlB;AAEAL,QAAAA,MAAM,CACHD,GADH,CACOnB,OADP,EAEG2B,MAFH,CAEU;AAAEC,UAAAA,QAAQ,EAAEkB;AAAZ,SAFV,EAGG5B,IAHH,CAGSW,KAAD,IAAW;AACfrB,UAAAA,QAAQ,CAACJ,MAAM,CAACJ,OAAD,EAAUa,SAAS,CAACG,GAApB,CAAP,CAAR;;AACA,cAAIK,IAAJ,EAAU;AACR,gBAAIU,QAAQ,CAACV,IAAI,CAACO,QAAN,CAAR,KAA4B,CAAhC,EAAmC;AACjC;AACD;;AACDpB,YAAAA,QAAQ,CACNd,WAAW,CAACoC,UAAZ,CAAuB9B,OAAvB,EAAgC;AAC9B4B,cAAAA,QAAQ,EAAEG,QAAQ,CAACV,IAAI,CAACO,QAAN,CAAR,GAA0B;AADN,aAAhC,CADM,CAAR;AAKD;AACF,SAfH;AAgBD,OA1BH;AA2BD,KAlCH,EAmCGc,KAnCH,CAmCUC,KAAD,IAAW;AAChBJ,MAAAA,OAAO,CAACC,GAAR,CAAY,0BAAZ;AACD,KArCH;AAsCD,GA1CD;AA2CD,CA5CD;;AA6CA,eAAenD,aAAa,CAC1B;AACE,GAACM,QAAD,GAAY,CAACoD,KAAD,EAAQC,MAAR,KAAmB1D,OAAO,CAACyD,KAAD,EAASE,KAAD,IAAW;AACvDA,IAAAA,KAAK,CAAC3C,IAAN,CAAWL,QAAX,GAAsB+C,MAAM,CAACE,OAAP,CAAejD,QAArC;AACD,GAFqC,CADxC;AAIE,GAACL,QAAD,GAAY,CAACmD,KAAD,EAAQC,MAAR,KACV1D,OAAO,CAACyD,KAAD,EAASE,KAAD,IAAW;AACxBA,IAAAA,KAAK,CAAC3C,IAAN,CAAW0C,MAAM,CAACE,OAAP,CAAelD,OAA1B,EAAmCqC,IAAnC,CAAwCW,MAAM,CAACE,OAAP,CAAe/C,OAAvD;AACD,GAFM,CALX;AAQE,GAACN,OAAD,GAAW,CAACkD,KAAD,EAAQC,MAAR,KACT1D,OAAO,CAACyD,KAAD,EAASE,KAAD,IAAW;AACxBA,IAAAA,KAAK,CAACE,UAAN,GAAmBH,MAAM,CAACE,OAAP,CAAeC,UAAlC;AACD,GAFM;AATX,CAD0B,EAc1B9C,YAd0B,CAA5B;AAiBA,MAAMZ,cAAc,GAAG;AACrBc,EAAAA,SADqB;AAErByB,EAAAA,SAFqB;AAGrBY,EAAAA;AAHqB,CAAvB;AAMA,SAASnD,cAAT","sourcesContent":["import { createAction, handleActions } from \"redux-actions\";\nimport { produce } from \"immer\";\nimport { firestore } from \"../../shared/firebase\";\nimport firebase from \"firebase\";\nimport { actionCreators as postActions } from \"./post\";\n\nconst SET_LIKE = \"SET_LIKE\";\nconst ADD_LIKE = \"ADD_LIKE\";\nconst LOADING = \"LOADING\";\nconst UN_LIKE = \"UN_LIKE\";\n\nconst setlike = createAction(SET_LIKE, (post_id, is_liked) => ({\n  post_id,\n  is_liked,\n}));\nconst addlike = createAction(ADD_LIKE, (post_id, user_id) => ({\n  post_id,\n  user_id,\n}));\nconst unlike = createAction(UN_LIKE, (post_id, user_id) => ({\n  post_id,\n  user_id,\n}));\n\n\nconst initialState = {\n  list: {\n\n  },\n};\n\nconst addLikeFB = (post_id) => {\n  return function (dispatch, getState, { history }) {\n    const likeDB = firestore.collection(\"like\");\n    const user_info = getState().user.user;\n\n    let like = {\n      post_id: post_id,\n      user_id: user_info.uid,\n    };\n\n    likeDB.add(like).then((doc) => {\n      const postDB = firestore.collection(\"post\");\n\n      const post = getState().post.list.find((l) => l.id === post_id);\n\n      const increment = firebase.firestore.FieldValue.increment(1);\n\n      like = { ...like, id: doc.id };\n\n      postDB\n        .doc(post_id)\n        .update({ like_cnt: increment })\n        .then((_post) => {\n          dispatch(addlike(post_id, user_info.uid));\n\n          if (post) {\n            dispatch(\n              postActions.updatePost(post_id, {\n                like_cnt: parseInt(post.like_cnt) + 1,\n              })\n            );\n          }\n        });\n    });\n  };\n};\n\nconst getLikeFB = (post_id) => {\n  return function (dispatch, getState, { history }) {\n    if (!post_id) {\n      return;\n    }\n\n    const likeDB = firestore.collection(\"like\");\n\n    likeDB\n      .where(\"post_id\", \"==\", post_id)\n      .get()\n      .then((docs) => {\n        let list = [];\n        docs.forEach((doc) => {\n          list.push(doc.data().user_id);\n        });\n        console.log(list);\n\n        dispatch(setLike(post_id, list));\n      })\n      .catch((error) => {\n        console.log(\"좋아요 정보를 가져올 수가 없네요ㅜㅜ\", error);\n      });\n  };\n};\n\nconst unLikeFB = (post_id) => {\n  return function (dispatch, getState, { history }) {\n    const likeDB = firestore.collection(\"like\");\n    const user_info = getState().user.user;\n\n    likeDB\n      .where(\"post_id\", \"==\", post_id)\n      .where(\"user_id\", \"==\", user_info.uid)\n      .get()\n      .then((docs) => {\n        let id = \"\";\n        docs.forEach((doc) => (id = doc.id));\n        likeDB\n          .doc(id)\n          .delete()\n          .then(() => {\n            const postDB = firestore.collection(\"post\");\n\n            const post = getState().post.list.find((l) => l.id === post_id);\n\n            const decrement = firebase.firestore.FieldValue.increment(-1);\n\n            postDB\n              .doc(post_id)\n              .update({ like_cnt: decrement })\n              .then((_post) => {\n                dispatch(unlike(post_id, user_info.uid));\n                if (post) {\n                  if (parseInt(post.like_cnt) === 0) {\n                    return;\n                  }\n                  dispatch(\n                    postActions.updatePost(post_id, {\n                      like_cnt: parseInt(post.like_cnt) - 1,\n                    })\n                  );\n                }\n              });\n          });\n      })\n      .catch((error) => {\n        console.log(\"좋아요를 취소할 포스트를 찾을수가 없어요ㅜㅜ\");\n      });\n  };\n};\nexport default handleActions(\n  {\n    [SET_LIKE]: (state, action) => produce(state, (draft) => {\n      draft.list.is_liked = action.payload.is_liked;\n    }),\n    [ADD_LIKE]: (state, action) =>\n      produce(state, (draft) => {\n        draft.list[action.payload.post_id].push(action.payload.user_id);\n      }),\n    [LOADING]: (state, action) =>\n      produce(state, (draft) => {\n        draft.is_loading = action.payload.is_loading;\n      }),\n  },\n  initialState\n);\n\nconst actionCreators = {\n  addLikeFB,\n  getLikeFB,\n  unLikeFB,\n};\n\nexport { actionCreators };\n"]},"metadata":{},"sourceType":"module"}